<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TexSaarthi - Invoices</title>
  <link rel="stylesheet" href="styles.css">
    <script src="auth.js" defer></script>
    <script src="api.js" defer></script>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">TexSaarthi</div>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="orders.html">Orders</a>
      <a class="active" href="invoices.html">Invoices</a>
      <a href="inventory.html">Inventory</a>
      <a href="deliveries.html">Deliveries</a>
      <a href="customers.html">Customers</a>
      <a href="reports.html">Reports</a>
      <a href="settings.html">Settings</a>
    </nav>
  </aside>

  <main class="content">
    <header class="topbar">
      <h1>Invoice Management</h1>
      <div>
        <span id="welcome-user" class="hidden" style="margin-right:8px;"></span>
        <button class="btn success" id="create-invoice-btn">Create Invoice</button>
        <button id="logout-btn" class="btn secondary hidden" style="margin-left:8px;">Logout</button>
      </div>
    </header>

    <section class="cards">
      <div class="card green">
        <div class="card-title">Total Invoices</div>
        <div class="card-value" id="total-invoices">Loading...</div>
      </div>
      <div class="card blue">
        <div class="card-title">Paid</div>
        <div class="card-value" id="paid-invoices">Loading...</div>
      </div>
      <div class="card red">
        <div class="card-title">Unpaid</div>
        <div class="card-value" id="unpaid-invoices">Loading...</div>
      </div>
      <div class="card orange">
        <div class="card-title">AI Generated</div>
        <div class="card-value" id="ai-generated-invoices">Loading...</div>
      </div>
    </section>

    <div class="panel">
      <div class="searchbar">
        <input id="invoice-search" type="text" placeholder="Search invoices by customer name or invoice number...">
        <select id="invoice-status">
          <option value="">All Status</option>
          <option value="paid">paid</option>
          <option value="pending">unpaid</option>
          <option value="partial">partial</option>
        </select>
        <button id="invoice-filter" class="btn">Filter</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Due Date</th>
            <th>Amount</th>
            <th>Paid</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invoices-tbody">
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px;">Loading invoices...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- AI Invoice Generation Modal -->
  <div id="ai-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ðŸ¤– AI Invoice Generator</h2>
        <button class="modal-close" onclick="closeAIModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="ai-step1" class="ai-step">
          <h3>Step 1: Select Orders</h3>
          <p>Choose orders to generate invoices for:</p>
          <div id="orders-list" class="orders-list">
            <div>Loading orders...</div>
          </div>
          <div class="modal-actions">
            <button class="btn secondary" onclick="closeAIModal()">Cancel</button>
            <button class="btn primary" id="proceed-analysis-btn" disabled>Analyze Selected Orders</button>
          </div>
        </div>
        
        <div id="ai-step2" class="ai-step hidden">
          <h3>Step 2: AI Analysis Results</h3>
          <div id="analysis-results"></div>
          <div class="modal-actions">
            <button class="btn secondary" onclick="showStep1()">Back</button>
            <button class="btn primary" id="generate-invoices-btn">Generate Invoices</button>
          </div>
        </div>
        
        <div id="ai-step3" class="ai-step hidden">
          <h3>Step 3: Generation Results</h3>
          <div id="generation-results"></div>
          <div class="modal-actions">
            <button class="btn primary" onclick="closeAIModal(); loadInvoices()">Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Fallback API if api.js fails to load
    function createMinimalAPI(){
      const BASE = 'http://localhost:3000/api';
      async function req(endpoint, options={}){
        const res = await fetch(BASE + endpoint, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      }
      return {
        async getInvoices(filters={}){
          const params = new URLSearchParams();
          if (filters.status) params.append('status', filters.status);
          if (filters.search) params.append('search', filters.search);
          const j = await req(`/invoices${params.toString()?`?${params.toString()}`:''}`);
          return (j && j.invoices) || [];
        },
        async getOrders(){
          const j = await req('/orders');
          return (j && j.orders) || [];
        },
        async request(path, options){
          return await req(path, options);
        },
        async getAIInvoiceStats(){ return { stats: { total_ai_invoices: 0 } }; }
      }
    }
    const api = (window.api) ? window.api : createMinimalAPI();
    let selectedOrders = [];
    let analysisData = [];

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      // Auto-login if not logged in
      if (!isLoggedIn()) {
        try {
          const api = new TexSarthiAPI();
          const loginResult = await api.login('admin@texsarthi.com', 'admin123');
          console.log('Auto-logged in successfully');
        } catch (error) {
          console.log('Auto-login failed, using demo mode');
          setSession('demo-token', 'admin@texsarthi.com', 'Admin');
        }
      }
      
      updateTopbarUI();
      attachLogoutHandler();
      
      await loadInvoices();
      
      // Set up event listeners
      document.getElementById('create-invoice-btn').addEventListener('click', quickCreateInvoice);
      document.getElementById('invoice-filter').addEventListener('click', loadInvoices);
      document.getElementById('invoice-search').addEventListener('keydown', function(e){ if(e.key==='Enter'){ loadInvoices(); }});
      document.getElementById('invoice-search').addEventListener('input', function(e){ 
        // Real-time search as you type (with a small delay to avoid too many requests)
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
          loadInvoices();
        }, 500);
      });
      document.getElementById('invoice-status').addEventListener('change', loadInvoices);
    });

    // Load invoices data
    async function loadInvoices() {
      try {
        const filters = { };
        const s = document.getElementById('invoice-search');
        const st = document.getElementById('invoice-status');
        if (s && s.value.trim()) filters.search = s.value.trim();
        if (st && st.value) filters.status = st.value;
        const invoices = await api.getInvoices(filters);
        
        // Update statistics
        const totalInvoices = invoices.length;
        const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
        const unpaidInvoices = invoices.filter(inv => inv.status === 'pending').length;
        
        document.getElementById('total-invoices').textContent = totalInvoices;
        document.getElementById('paid-invoices').textContent = paidInvoices;
        document.getElementById('unpaid-invoices').textContent = unpaidInvoices;
        
        // Get AI-generated invoices count
        try {
          const aiStats = await api.getAIInvoiceStats();
          document.getElementById('ai-generated-invoices').textContent = aiStats.stats.total_ai_invoices || 0;
        } catch (error) {
          document.getElementById('ai-generated-invoices').textContent = '0';
        }
        
        // Render invoices table
        renderInvoicesTable(invoices);
        
      } catch (error) {
        console.error('Failed to load invoices:', error);
        // Show zero values instead of error
        document.getElementById('total-invoices').textContent = '0';
        document.getElementById('paid-invoices').textContent = '0';
        document.getElementById('unpaid-invoices').textContent = '0';
        document.getElementById('ai-generated-invoices').textContent = '0';
        
        // Show helpful message in table
        const tbody = document.getElementById('invoices-tbody');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">Unable to load invoices. Please check backend connection.</td></tr>';
      }
    }

    // Render invoices table
    function renderInvoicesTable(invoices) {
      const tbody = document.getElementById('invoices-tbody');
      
      if (invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No invoices found</td></tr>';
        return;
      }
      
      tbody.innerHTML = invoices.map(invoice => `
        <tr>
          <td>${invoice.invoice_number}</td>
          <td>${invoice.customer_id ? ('Customer #' + invoice.customer_id) : (invoice.customer_name || 'N/A')}</td>
          <td>${formatDate(invoice.created_at)}</td>
          <td>${formatDate(invoice.due_date)}</td>
          <td>â‚¹${invoice.total_amount.toLocaleString()}</td>
          <td>â‚¹${invoice.status === 'paid' ? invoice.total_amount.toLocaleString() : '0'}</td>
          <td><span class="status ${getStatusClass(invoice.status)}">${invoice.status}</span></td>
          <td>
            <button class="btn elevated" onclick="viewInvoice(${invoice.id})">View</button>
            <button class="btn elevated" onclick="downloadInvoice(${invoice.id})">Download</button>
          </td>
        </tr>
      `).join('');
    }

    // Quick create invoice flow (no AI)
    async function quickCreateInvoice() {
      try {
        // Get orders from backend
        const orders = await api.getOrders();
        if (!orders || orders.length === 0) {
          alert('No orders available. Please create an order first.');
          return;
        }
        
        // Show available orders to user
        const orderList = orders.map(o => `ID: ${o.id} - ${o.order_number} (${o.customer_name})`).join('\n');
        const idStr = prompt(`Available Orders:\n${orderList}\n\nEnter Order ID (e.g., 1, 2, 3):`);
        if (idStr === null) return;
        
        const orderId = Number(idStr);
        if (!orderId || isNaN(orderId)) {
          alert('Please enter a valid Order ID (number).');
          return;
        }
        
        // Verify order exists
        const order = orders.find(o => o.id === orderId);
        if (!order) {
          alert(`Order with ID ${orderId} not found. Please try again.`);
          return;
        }
        
        // Create invoice using the order ID
        const response = await api.request(`/orders/${orderId}/invoice`, { 
          method: 'POST', 
          body: JSON.stringify({}) 
        });
        
        alert(`Invoice created successfully!\nInvoice Number: ${response.invoice.invoice_number}\nAmount: â‚¹${response.invoice.total_amount}`);
        await loadInvoices();
      } catch (e) {
        console.error('Invoice creation error:', e);
        alert('Failed to create invoice: ' + (e.message || e));
      }
    }

    // View invoice details
    async function viewInvoice(invoiceId) {
      try {
        const response = await api.request(`/invoices/${invoiceId}/view`, { method: 'GET' });
        const invoice = response.invoice;
        
        // Create modal content
        const modalContent = `
          <div class="modal-overlay" onclick="closeInvoiceModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h2>Invoice Details</h2>
                <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
              </div>
              <div class="modal-body">
                <div class="invoice-details">
                  <div class="detail-section">
                    <h3>Invoice Information</h3>
                    <p><strong>Invoice Number:</strong> ${invoice.invoice_number}</p>
                    <p><strong>Invoice Date:</strong> ${formatDate(invoice.created_at)}</p>
                    <p><strong>Due Date:</strong> ${formatDate(invoice.due_date)}</p>
                    <p><strong>Status:</strong> <span class="status ${getStatusClass(invoice.status)}">${invoice.status}</span></p>
                  </div>
                  
                  ${invoice.customer ? `
                  <div class="detail-section">
                    <h3>Customer Information</h3>
                    <p><strong>Name:</strong> ${invoice.customer.name}</p>
                    <p><strong>Phone:</strong> ${invoice.customer.phone || 'N/A'}</p>
                    <p><strong>Email:</strong> ${invoice.customer.email || 'N/A'}</p>
                    <p><strong>Address:</strong> ${invoice.customer.address || 'N/A'}</p>
                  </div>
                  ` : ''}
                  
                  ${invoice.order ? `
                  <div class="detail-section">
                    <h3>Order Information</h3>
                    <p><strong>Order Number:</strong> ${invoice.order.order_number}</p>
                    <p><strong>Order Date:</strong> ${formatDate(invoice.order.created_at)}</p>
                    <p><strong>Item Type:</strong> ${invoice.order.order_type || 'N/A'}</p>
                    <p><strong>Fabric:</strong> ${invoice.order.fabric || 'N/A'}</p>
                    <p><strong>Color:</strong> ${invoice.order.color || 'N/A'}</p>
                    <p><strong>Quantity:</strong> ${invoice.order.quantity}</p>
                    <p><strong>Notes:</strong> ${invoice.order.notes || 'N/A'}</p>
                  </div>
                  ` : ''}
                  
                  <div class="detail-section">
                    <h3>Amount Details</h3>
                    <p><strong>Subtotal:</strong> â‚¹${invoice.amount.toLocaleString()}</p>
                    <p><strong>Tax (18%):</strong> â‚¹${invoice.tax_amount.toLocaleString()}</p>
                    <p><strong>Total Amount:</strong> â‚¹${invoice.total_amount.toLocaleString()}</p>
                  </div>
                  
                  ${invoice.notes ? `
                  <div class="detail-section">
                    <h3>Notes</h3>
                    <p>${invoice.notes}</p>
                  </div>
                  ` : ''}
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn elevated" onclick="downloadInvoice(${invoiceId})">Download PDF</button>
                <button class="btn" onclick="closeInvoiceModal()">Close</button>
              </div>
            </div>
          </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);
        
      } catch (error) {
        console.error('Failed to load invoice details:', error);
        alert('Failed to load invoice details: ' + (error.message || error));
      }
    }

    // Download invoice as PDF
    async function downloadInvoice(invoiceId) {
      try {
        const response = await fetch(`http://localhost:3000/api/invoices/${invoiceId}/download`);
        
        if (!response.ok) {
          throw new Error('Failed to download invoice');
        }
        
        // Get filename from response headers
        const contentDisposition = response.headers.get('Content-Disposition');
        const filename = contentDisposition 
          ? contentDisposition.split('filename=')[1] 
          : `invoice_${invoiceId}.pdf`;
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Failed to download invoice:', error);
        alert('Failed to download invoice: ' + (error.message || error));
      }
    }

    // Close invoice modal
    function closeInvoiceModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) {
        modal.remove();
      }
    }

    // Disabled AI modal since backend AI endpoints are not available

    // Close AI modal
    function closeAIModal() {
      document.getElementById('ai-modal').classList.add('hidden');
      selectedOrders = [];
      analysisData = [];
    }

    // Load orders without invoices for AI generation
    async function loadOrdersForAI() {
      try {
        const response = await api.getOrders();
        const orders = response.orders || [];
        
        // Filter orders that don't have invoices yet
        const ordersWithoutInvoices = orders.filter(order => 
          order.status === 'pending' || order.status === 'in_progress'
        );
        
        const ordersList = document.getElementById('orders-list');
        
        if (ordersWithoutInvoices.length === 0) {
          ordersList.innerHTML = '<div class="no-orders">No orders available for invoice generation</div>';
          return;
        }
        
        ordersList.innerHTML = ordersWithoutInvoices.map(order => `
          <div class="order-item">
            <label>
              <input type="checkbox" value="${order.id}" onchange="toggleOrderSelection(${order.id})">
              <div class="order-details">
                <strong>${order.order_number}</strong> - ${order.customer_name}<br>
                <small>${order.order_type} Â· ${order.fabric} Â· â‚¹${order.order_value}</small>
              </div>
            </label>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load orders:', error);
        document.getElementById('orders-list').innerHTML = '<div class="error">Failed to load orders</div>';
      }
    }

    // Toggle order selection
    function toggleOrderSelection(orderId) {
      if (selectedOrders.includes(orderId)) {
        selectedOrders = selectedOrders.filter(id => id !== orderId);
      } else {
        selectedOrders.push(orderId);
      }
      
      document.getElementById('proceed-analysis-btn').disabled = selectedOrders.length === 0;
    }

    // Analyze selected orders
    async function analyzeSelectedOrders() {
      if (selectedOrders.length === 0) return;
      
      const resultsDiv = document.getElementById('analysis-results');
      resultsDiv.innerHTML = '<div class="loading">Analyzing orders with AI...</div>';
      
      showStep2();
      
      try {
        analysisData = [];
        
        for (const orderId of selectedOrders) {
          const analysis = await api.analyzeOrderForInvoice(orderId);
          const suggestions = await api.getAIInvoiceSuggestions(orderId);
          
          analysisData.push({
            orderId,
            analysis: analysis.analysis,
            suggestions: suggestions.suggestions,
            recommendations: analysis.recommendations
          });
        }
        
        // Display analysis results
        resultsDiv.innerHTML = analysisData.map(data => `
          <div class="analysis-item">
            <h4>Order #${data.orderId}</h4>
            <div class="analysis-details">
              <p><strong>Complexity:</strong> ${data.recommendations.complexity_level}</p>
              <p><strong>Estimated Hours:</strong> ${data.recommendations.estimated_completion_hours}</p>
              <p><strong>Tax Rate:</strong> ${data.recommendations.suggested_tax_rate}%</p>
              <p><strong>Estimated Total:</strong> â‚¹${data.suggestions.estimated_total.toLocaleString()}</p>
            </div>
            <div class="suggested-items">
              <strong>Suggested Items:</strong>
              <ul>
                ${data.suggestions.suggested_items.map(item => `
                  <li>${item.description} - â‚¹${item.total_price} (${item.tax_rate}% tax)</li>
                `).join('')}
              </ul>
            </div>
            <p class="ai-notes"><em>${data.suggestions.ai_notes}</em></p>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Analysis failed:', error);
        resultsDiv.innerHTML = '<div class="error">Analysis failed. Please try again.</div>';
      }
    }

    // Generate invoices for selected orders
    async function generateSelectedInvoices() {
      const resultsDiv = document.getElementById('generation-results');
      resultsDiv.innerHTML = '<div class="loading">Generating AI invoices...</div>';
      
      showStep3();
      
      try {
        const results = await api.bulkGenerateAIInvoices(selectedOrders, {
          save_to_db: true,
          auto_calculate: true
        });
        
        resultsDiv.innerHTML = `
          <div class="success">
            <h4>âœ“ Successfully Generated ${results.generated_count} Invoices</h4>
            <div class="generated-invoices">
              ${results.generated_invoices.map(invoice => `
                <div class="invoice-result">
                  <strong>${invoice.invoice_number}</strong> - ${invoice.customer_name}<br>
                  <small>Amount: â‚¹${invoice.total_amount.toLocaleString()}</small>
                </div>
              `).join('')}
            </div>
            <p class="success-message">All invoices have been saved to the database and are ready for use.</p>
          </div>
        `;
        
      } catch (error) {
        console.error('Invoice generation failed:', error);
        resultsDiv.innerHTML = '<div class="error">Invoice generation failed. Please try again.</div>';
      }
    }

    // Modal step navigation
    function showStep1() {
      document.querySelectorAll('.ai-step').forEach(step => step.classList.add('hidden'));
      document.getElementById('ai-step1').classList.remove('hidden');
    }

    function showStep2() {
      document.querySelectorAll('.ai-step').forEach(step => step.classList.add('hidden'));
      document.getElementById('ai-step2').classList.remove('hidden');
    }

    function showStep3() {
      document.querySelectorAll('.ai-step').forEach(step => step.classList.add('hidden'));
      document.getElementById('ai-step3').classList.remove('hidden');
    }

    // Utility functions
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleDateString();
    }

    function getStatusClass(status) {
      const statusMap = {
        'paid': 'green',
        'pending': 'red',
        'overdue': 'red',
        'partial': 'yellow'
      };
      return statusMap[status] || 'gray';
    }

    // This function is now implemented above
  </script>

  <!-- Add modal styles -->
  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.hidden {
      display: none;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 80%;
      overflow-y: auto;
    }

    /* Invoice details modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .close-btn:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .invoice-details {
      display: grid;
      gap: 20px;
    }

    .detail-section {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }

    .detail-section h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }

    .detail-section p {
      margin: 5px 0;
      color: #666;
    }

    .detail-section strong {
      color: #333;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      color: #666;
    }
    
    .order-item {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .order-item label {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      cursor: pointer;
    }
    
    .order-details {
      flex: 1;
    }
    
    .analysis-item {
      padding: 15px;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      margin-bottom: 15px;
      background: #f8f9fa;
    }
    
    .analysis-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    
    .suggested-items ul {
      margin: 5px 0;
      padding-left: 20px;
    }
    
    .ai-notes {
      font-style: italic;
      color: #666;
      margin-top: 10px;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .success {
      color: #28a745;
      text-align: center;
    }
    
    .error {
      color: #dc3545;
      text-align: center;
      padding: 20px;
    }
    
    .generated-invoices {
      margin: 15px 0;
    }
    
    .invoice-result {
      padding: 8px;
      background: #e8f5e8;
      border-radius: 4px;
      margin-bottom: 5px;
    }
  </style>
</body>
</html>


