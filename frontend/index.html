<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TexSaarthi - Dashboard</title>
  <link rel="stylesheet" href="styles.css">
    <script src="auth.js" defer></script>
    <script src="api.js" defer></script>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">TexSaarthi</div>
    <nav>
      <a class="active" href="index.html">Dashboard</a>
      <a href="orders.html">Orders</a>
      <a href="invoices.html">Invoices</a>
      <a href="inventory.html">Inventory</a>
      <a href="deliveries.html">Deliveries</a>
      <a href="customers.html">Customers</a>
      <a href="reports.html">Reports</a>
      <a href="settings.html">Settings</a>
    </nav>
  </aside>

  <main class="content">
    <header class="topbar">
      <h1>Textile Management - Dashboard</h1>
      <div class="topbar-actions">
        <span id="welcome-user" class="hidden" style="margin-right:8px;"></span>
        <a class="btn primary" href="add-order.html">Add New Order</a>
        <button id="logout-btn" class="btn secondary hidden" style="margin-left:8px;">Logout</button>
      </div>
    </header>

    <section class="cards">
      <div class="card blue">
        <div class="card-title">Total Orders</div>
        <div class="card-value" id="total-orders">Loading...</div>
      </div>
      <div class="card red">
        <div class="card-title">Low Stock Items</div>
        <div class="card-value" id="low-stock-items">Loading...</div>
      </div>
      <div class="card orange">
        <div class="card-title">Pending Deliveries</div>
        <div class="card-value" id="pending-deliveries">Loading...</div>
      </div>
      <div class="card green">
        <div class="card-title">Outstanding Amount</div>
        <div class="card-value" id="outstanding-amount">Loading...</div>
      </div>
    </section>

    <section class="grid-2">
      <div class="panel">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
          <a class="btn light" href="add-order.html">Add New Order</a>
          <a class="btn light" href="invoices.html">Create Invoice</a>
          <a class="btn light" href="add-stock.html">Update Inventory</a>
          <a class="btn light" href="deliveries.html">Record Delivery</a>
          <a class="btn light" href="deliveries.html">Cheak deliveries</a>
          <a class="btn light" href="reports.html">Cheak Reports</a>
        </div>
      </div>

      <div class="panel">
        <h2>Recent Activities</h2>
        <ul class="list" id="recent-activities">
          <li>Loading recent activities...</li>
        </ul>
      </div>
    </section>

    <section class="grid-2">
      <div class="panel">
        <h2>Today's Tasks</h2>
        <div class="searchbar" style="margin:8px 0 10px;">
          <input id="task-input" type="text" placeholder="Add a new task for today...">
          <button id="add-task-btn" class="btn primary">Add Task</button>
        </div>
        <ul id="tasks-list" class="tasks">
          <li><input type="checkbox"> Complete order #1234</li>
          <li class="done"><input type="checkbox" checked> Update inventory for silk fabric</li>
          <li><input type="checkbox"> Send invoice to Rajesh Textiles</li>
          <li><input type="checkbox"> Prepare delivery for tomorrow</li>
        </ul>
      </div>
      <div class="panel">
        <h2>Notes</h2>
        <p></p>
      </div>
    </section>

  </main>
  <script>
    // Dashboard data loading
    document.addEventListener('DOMContentLoaded', async function() {
      // Auto-login if not logged in
      if (!isLoggedIn()) {
        try {
          const api = new TexSarthiAPI();
          const loginResult = await api.login('admin@texsarthi.com', 'admin123');
          console.log('Auto-logged in successfully');
        } catch (error) {
          console.log('Auto-login failed, using demo mode');
          setSession('demo-token', 'admin@texsarthi.com', 'Admin');
        }
      }
      
      // Protect page and update UI
      updateTopbarUI();
      attachLogoutHandler();
      
      // Load dashboard data (first, attempt to sync any local orders to DB)
      try {
        try {
          const localRaw = localStorage.getItem('orders_list') || '[]';
          const localOrders = JSON.parse(localRaw);
          if (Array.isArray(localOrders) && localOrders.length > 0) {
            // Minimal client to push orders if api.js is missing
            const base = 'http://localhost:3000/api';
            for (const loc of localOrders) {
              try {
                // Create/ensure customer
                const customerPayload = {
                  name: String(loc.customer || loc.customer_name || 'Customer').trim().slice(0,100),
                  email: (loc.customer_email || '').trim() || undefined,
                  phone: (loc.customer_phone || '').trim() || undefined,
                  address: (loc.customer_address || '').trim() || undefined
                };
                let customerId;
                try {
                  const cRes = await fetch(`${base}/customers`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(customerPayload)});
                  if (cRes.ok) { const cj = await cRes.json(); customerId = cj.id; }
                } catch(_){ }
                const orderPayload = {
                  order_number: loc.order_number || undefined,
                  customer_name: customerPayload.name,
                  customer_id: customerId,
                  order_type: loc.order_type || 'fabric',
                  status: loc.status || 'pending',
                  quantity: Number(loc.quantity || loc.qty || 1),
                  order_value: Number(loc.order_value || loc.amount || 0),
                  advance_payment: Number(loc.advance_payment || 0)
                };
                const oRes = await fetch(`${base}/orders`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(orderPayload)});
                // ignore failures (it might already exist)
              } catch(_) {}
            }
          }
        } catch(_) {}

        let stats;
        if (window.api && window.api.getDashboardStats) {
          stats = await window.api.getDashboardStats();
        } else {
          const res = await fetch('http://localhost:3000/api/dashboard/stats');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          stats = await res.json();
        }
        
        // Update dashboard cards
        document.getElementById('total-orders').textContent = stats.totalOrders || 0;
        document.getElementById('low-stock-items').textContent = stats.lowStockItems || 0;
        document.getElementById('pending-deliveries').textContent = stats.pendingDeliveries || 0;
        document.getElementById('outstanding-amount').textContent = `₹${(stats.outstandingAmount || 0).toLocaleString()}`;
        
        // Update recent activities
        const activitiesList = document.getElementById('recent-activities');
        if (stats.recentActivity && stats.recentActivity.length > 0) {
          activitiesList.innerHTML = '';
          stats.recentActivity.slice(0, 5).forEach(activity => {
            const li = document.createElement('li');
            li.textContent = `Order ${activity.orderNumber} - ${activity.customerName} (${activity.status})`;
            activitiesList.appendChild(li);
          });
        } else {
          activitiesList.innerHTML = '<li>No recent activities</li>';
        }
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        // Show fallback data with zero values instead of error
        document.getElementById('total-orders').textContent = '0';
        document.getElementById('low-stock-items').textContent = '0';
        document.getElementById('pending-deliveries').textContent = '0';
        document.getElementById('outstanding-amount').textContent = '₹0';
        
        // Update recent activities with helpful message
        const activitiesList = document.getElementById('recent-activities');
        if (activitiesList) {
          activitiesList.innerHTML = '<li>No data available - Please check connection to backend</li>';
        }
      }
    });

    // Task management functionality
    (function(){
      var input = document.getElementById('task-input');
      var btn = document.getElementById('add-task-btn');
      var list = document.getElementById('tasks-list');
      if (!input || !btn || !list) return;
      function addTask(){
        var text = (input.value || '').trim();
        if (!text) return;
        var li = document.createElement('li');
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        li.appendChild(cb);
        li.appendChild(document.createTextNode(' ' + text));
        list.insertBefore(li, list.firstChild);
        input.value = '';
        input.focus();
      }
      btn.addEventListener('click', addTask);
      input.addEventListener('keydown', function(e){ if (e.key === 'Enter') addTask(); });
      list.addEventListener('change', function(e){
        var target = e.target;
        if (target && target.matches('input[type="checkbox"]')) {
          var li = target.closest('li');
          if (li) li.classList.toggle('done', target.checked);
        }
      });
    })();
  </script>
</body>
</html>


